<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Mimic (mimic.Mimic)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">mimic</a> &#x00BB; Mimic</nav><header class="odoc-preamble"><h1>Module <code><span>Mimic</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-Mirage_protocol" class="anchored"><a href="#module-Mirage_protocol" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Mirage_protocol/index.html">Mirage_protocol</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-flow" class="anchored"><a href="#type-flow" class="anchor"></a><code><span><span class="keyword">type</span> flow</span><span> = <span class="keyword">private</span> </span><span>..</span></code></div><div class="spec-doc"><p>The type for flows. A flow represents the state of a single reliable stream stream that is connected to an <i>endpoint</i>.</p></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="xref-unresolved">Mirage_flow</span>.S
  <span class="keyword">with</span> <span><span class="keyword">type</span> <span class="xref-unresolved">flow</span> := <span class="xref-unresolved">flow</span></span>
   <span class="keyword">and</span> <span><span class="keyword">type</span> <span class="xref-unresolved">error</span> = <span>[ <span>`Msg of <span class="xref-unresolved">string</span></span> <span>| `Not_found</span> <span>| `Cycle</span> ]</span></span></span></code></summary><div class="odoc-spec"><div class="spec type" id="type-error" class="anchored"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span><span> = </span><span>[ </span></code><table><tr id="type-error.Cycle" class="anchored"><td class="def constructor"><a href="#type-error.Cycle" class="anchor"></a><code><span>| </span></code><code><span>`Cycle</span></code></td></tr><tr id="type-error.Msg" class="anchored"><td class="def constructor"><a href="#type-error.Msg" class="anchor"></a><code><span>| </span></code><code><span>`Msg <span class="keyword">of</span> string</span></code></td></tr><tr id="type-error.Not_found" class="anchored"><td class="def constructor"><a href="#type-error.Not_found" class="anchor"></a><code><span>| </span></code><code><span>`Not_found</span></code></td></tr></table><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-pp_error" class="anchored"><a href="#val-pp_error" class="anchor"></a><code><span><span class="keyword">val</span> pp_error : <span><a href="#type-error">error</a> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-write_error" class="anchored"><a href="#type-write_error" class="anchor"></a><code><span><span class="keyword">type</span> <span class="keyword">nonrec</span> write_error</span><span> = <span class="keyword">private</span> </span><span>[&gt; </span></code><table><tr id="type-write_error.Mirage_flow.write_error" class="anchored"><td class="def type"><a href="#type-write_error.Mirage_flow.write_error" class="anchor"></a><code><span>| </span></code><code><span><span class="xref-unresolved">Mirage_flow</span>.write_error</span></code></td></tr></table><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-pp_write_error" class="anchored"><a href="#val-pp_write_error" class="anchor"></a><code><span><span class="keyword">val</span> pp_write_error : <span><a href="#type-write_error">write_error</a> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-read" class="anchored"><a href="#val-read" class="anchor"></a><code><span><span class="keyword">val</span> read : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>( <span><span class="xref-unresolved">Cstruct</span>.t <span class="xref-unresolved">Mirage_flow</span>.or_eof</span>, <a href="#type-error">error</a> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-write" class="anchored"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Cstruct</span>.t <span class="arrow">&#45;&gt;</span></span> <span><span><span>( unit, <a href="#type-write_error">write_error</a> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-writev" class="anchored"><a href="#val-writev" class="anchor"></a><code><span><span class="keyword">val</span> writev : 
  <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="xref-unresolved">Cstruct</span>.t list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( unit, <a href="#type-write_error">write_error</a> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></details></div><div class="odoc-spec"><div class="spec type" id="type-ctx" class="anchored"><a href="#type-ctx" class="anchor"></a><code><span><span class="keyword">type</span> ctx</span></code></div><div class="spec-doc"><p>The type for contexts. It's a <i>heterogeneous map</i> of values to help mimic to instantiate a new <a href="#type-flow"><code>flow</code></a> <i>via</i> <a href="#val-resolve"><code>resolve</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-value" class="anchored"><a href="#type-value" class="anchor"></a><code><span><span class="keyword">type</span> <span>'edn value</span></span></code></div><div class="spec-doc"><p>The type for <i>witnesses</i> whose lookup value is of type <code>'edn</code>.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Fun" class="anchored"><a href="#module-Fun" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Fun/index.html">Fun</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-make" class="anchored"><a href="#val-make" class="anchor"></a><code><span><span class="keyword">val</span> make : <span>name:string <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'edn</span> <a href="#type-value">value</a></span></span></code></div><div class="spec-doc"><p><code>make ~name</code> is a new witness.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add" class="anchored"><a href="#val-add" class="anchor"></a><code><span><span class="keyword">val</span> add : <span><span><span class="type-var">'edn</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'edn</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-ctx">ctx</a></span></code></div><div class="spec-doc"><p><code>add w v ctx</code> is <code>ctx</code> with <code>w</code> bound to <code>v</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-get" class="anchored"><a href="#val-get" class="anchor"></a><code><span><span class="keyword">val</span> get : <span><span><span class="type-var">'edn</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'edn</span> option</span></span></code></div><div class="spec-doc"><p><code>get w ctx</code> is the value of <code>w</code>'s binding in <code>ctx</code>, if any.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-fold" class="anchored"><a href="#val-fold" class="anchor"></a><code><span><span class="keyword">val</span> fold : 
  <span><span><span class="type-var">'edn</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( <span class="type-var">'k</span>, <span><span><span class="type-var">'edn</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span> )</span> <a href="Fun/index.html#type-args">Fun.args</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>k:<span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-ctx">ctx</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-merge" class="anchored"><a href="#val-merge" class="anchor"></a><code><span><span class="keyword">val</span> merge : <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-ctx">ctx</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-empty" class="anchored"><a href="#val-empty" class="anchor"></a><code><span><span class="keyword">val</span> empty : <a href="#type-ctx">ctx</a></span></code></div><div class="spec-doc"><p><code>empty</code> is the empty context.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-protocol" class="anchored"><a href="#type-protocol" class="anchor"></a><code><span><span class="keyword">type</span> <span>('edn, 'flow) protocol</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-register" class="anchored"><a href="#val-register" class="anchor"></a><code><span><span class="keyword">val</span> register : 
  <span>?priority:int <span class="arrow">&#45;&gt;</span></span>
  <span>name:string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="Mirage_protocol/module-type-S/index.html">Mirage_protocol.S</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="Mirage_protocol/module-type-S/index.html#type-endpoint">endpoint</a> = <span class="type-var">'edn</span> <span class="keyword">and</span> <span class="keyword">type</span> <a href="Mirage_protocol/module-type-S/index.html#type-flow">flow</a> = <span class="type-var">'flow</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'edn</span> <a href="#type-value">value</a></span> * <span><span>( <span class="type-var">'edn</span>, <span class="type-var">'flow</span> )</span> <a href="#type-protocol">protocol</a></span></span></code></div><div class="spec-doc"><p><code>register ?priority ~name (module Protocol)</code> registers the given <code>Protocol</code> into the internal global Mimic's state as a possible transmission protocol available <i>via</i> <a href="#val-resolve"><code>resolve</code></a>.</p><p><code>?priority</code> is used to help mimic to choose between multiple solutions according to the given context. Mimic will choose the lower-priority solution.</p><p><code>name</code> helps the end-user to know which solution mimic will dynamically <i>via</i> log outputs.</p><p><code>register</code> returns 2 values:</p><ul><li>a <i>witness</i> as the required value to initiate a transmission <i>via</i> the given <code>Protocol</code> implementation</li><li>a <a href="#type-protocol"><code>protocol</code></a> which can help the end-user to destruct a <a href="#type-flow"><code>flow</code></a> to its structural type <i>via</i> <a href="#val-repr"><code>repr</code></a>.</li></ul></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-REPR" class="anchored"><a href="#module-type-REPR" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-REPR/index.html">REPR</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-repr" class="anchored"><a href="#val-repr" class="anchor"></a><code><span><span class="keyword">val</span> repr : <span><span><span>( <span class="type-var">'edn</span>, <span class="type-var">'flow</span> )</span> <a href="#type-protocol">protocol</a></span> <span class="arrow">&#45;&gt;</span></span> <span>(<span class="keyword">module</span> <a href="module-type-REPR/index.html">REPR</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="module-type-REPR/index.html#type-t">t</a> = <span class="type-var">'flow</span>)</span></span></code></div><div class="spec-doc"><p><code>repr protocol</code> gives a module definition with an OCaml constructor to help the end-user to destruct the structural type of a given <a href="#type-flow"><code>flow</code></a>:</p><pre><code>module Protocol
  : Mirage_protocol.S with type flow = Lwt_unix.file_descr

let edn, protocol = Mimic.register ~name:&quot;protocol&quot; (module Protocol)
module R = (val (Mimic.repr protocol))

let () = Mimic.resolve ~ctx &gt;&gt;= function
  | Ok (R.T lwt_unix_file_descr) -&gt; ...
  | ...</code></pre></div></div><div class="odoc-spec"><div class="spec value" id="val-resolve" class="anchored"><a href="#val-resolve" class="anchor"></a><code><span><span class="keyword">val</span> resolve : <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>( <a href="#type-flow">flow</a>, <span>[&gt; <a href="#type-error">error</a> ]</span> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>resolve ctx</code> tries to instantiate a <a href="#type-flow"><code>flow</code></a> from the given <code>ctx</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-edn" class="anchored"><a href="#type-edn" class="anchor"></a><code><span><span class="keyword">type</span> edn</span><span> = </span></code><table><tr id="type-edn.Edn" class="anchored"><td class="def variant constructor"><a href="#type-edn.Edn" class="anchor"></a><code><span>| </span><span><span class="constructor">Edn</span> : <span><span class="type-var">'edn</span> <a href="#type-value">value</a></span> * <span class="type-var">'edn</span> <span class="arrow">&#45;&gt;</span> <a href="#type-edn">edn</a></span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>The type of a value and its witness.</p><span class="comment-delim">*)</span></td></tr></table></div></div><div class="odoc-spec"><div class="spec type" id="type-refl" class="anchored"><a href="#type-refl" class="anchor"></a><code><span><span class="keyword">type</span> <span>(_, _) refl</span></span><span> = </span></code><table><tr id="type-refl.Refl" class="anchored"><td class="def variant constructor"><a href="#type-refl.Refl" class="anchor"></a><code><span>| </span><span><span class="constructor">Refl</span> : <span><span>( <span class="type-var">'a</span>, <span class="type-var">'a</span> )</span> <a href="#type-refl">refl</a></span></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-equal" class="anchored"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><span><span class="type-var">'a</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>( <span class="type-var">'a</span>, <span class="type-var">'b</span> )</span> <a href="#type-refl">refl</a></span> option</span></span></code></div><div class="spec-doc"><p><code>equal a b</code> returns a proof that <code>a</code> and <code>b</code> are <i>structurally</i> equal.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-unfold" class="anchored"><a href="#val-unfold" class="anchor"></a><code><span><span class="keyword">val</span> unfold : <span><a href="#type-ctx">ctx</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>( <span><a href="#type-edn">edn</a> list</span>, <span>[&gt; `Cycle ]</span> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>unfold ctx</code> applies any functions available into the given <code>ctx</code> and and possible to compute according to available values and return a list of what these functions return.</p><p>It's useful to do an introspection of what <code>mimic</code> does when it <a href="#val-resolve"><code>resolve</code></a>s the given <code>ctx</code>. From that and <a href="#val-equal"><code>equal</code></a>, the user is able to introspect what <code>mimic</code> generated and which protocol it is able to instantiate then.</p><pre>al:resolve} is:
    {[
      let resolve ctx =
        unfold ctx &gt;&gt;= function
        | Ok lst -&gt; connect lst
        | Error _ as err -&gt; Lwt.return err
    ]}</pre></div></div><div class="odoc-spec"><div class="spec value" id="val-connect" class="anchored"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : <span><span><a href="#type-edn">edn</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>( <a href="#type-flow">flow</a>, <span>[&gt; <a href="#type-error">error</a> ]</span> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>connect values</code> tries to instantiate a <a href="#type-flow"><code>flow</code></a> from given <code>values</code> and registered protocols (see <a href="#val-register"><code>register</code></a>).</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Merge" class="anchored"><a href="#module-Merge" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Merge/index.html">Merge</a></span><span> (<a href="Merge/argument-1-A/index.html">A</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span>) (<a href="Merge/argument-2-B/index.html">B</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span>) : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>